<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/water.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>packer</title>
    <link rel="stylesheet" href="/static/highlight.min.css">
    <script src="/static/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body {
            font-family: open sans, "SF Pro Display", system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";
            max-width: 960px;
            margin: 0 auto;
        }
        h2 > a {
            color: black;
            text-decoration: none;
        }
        h2 > a:hover {
            text-decoration: underline;
        }
        h2 > a:visited {
            color: black;
        }

        a:visited {
            color: blue;
        }

        .important {
            background-color: lightgray;
            padding: 1em
        }

        .chapter {
            font-style: italic;

        }
    </style>
</head>
<body>
<a href='/'>
    < back home
</a>
<hr>
<small><i>
Crated on <time datetime="2025-07-8">July 8, 2025</time>; Last modified on
<time datetime="2025-07-12">July 12, 2025.</time>
</i></small>
<br>
<h1 id='top'>~ packer</h1>
<a href='#table'>table of contents</a>
<h2 id='what'>what is packer?</h2>
<p>
Packer is a tool to create machine images for multiple platforms from a single
template.
</p>
<h2 id='using'>packer file structure</h2>
<p>
Packer uses configuration files to create the images, these are called
templates. They are coded in Hashicorp Configuration Language (hcl).
</p>
<p>
We will follow the documentation official tutorial on <a
href='https://developer.hashicorp.com/packer/tutorials/aws-get-started/aws-get-started-build-image'>how
to build an image</a> for this section. So go there for any clarifications.
</p>

<h3 id='packer'>packer block</h3>
<p>
You will have a <code>packer {}</code> block. Here you will have the setting
for packer, and you will add the plugins you need, например:
<pre>
<code>
packer {
  required_plugins {
    amazon = {
      version = ">= 1.2.8"
      source  = "github.com/hashicorp/amazon"
    }
  }
}
</code>
</pre>
</p>
<p>
You need to specify the <code>source</code> of the plugin; which is where
packer will look to download the plugin. <code>version</code> is optional
but nice to have.
</p>

<h3 id='source'>source block</h3>

<p>
This is the blueprint for the machine we want to build. Here we add all the
infrastructure information we need for it.
</p>

<p>
After the <code>source</code> keyword, we specify what type <i>builder
plugin</i> we are going to use. A <i>builder plugin</i> is a packer component
that will create the machine and make it into an image.
</p>

<pre>
<code>
source "amazon-ebs" "ubuntu" {
  ami_name      = "learn-packer-linux-aws"
  instance_type = "t2.micro"
  region        = "us-west-2"
  source_ami_filter {
    filters = {
      name                = "ubuntu/images/*ubuntu-jammy-22.04-amd64-server-*"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    most_recent = true
    owners      = ["099720109477"]
  }
  ssh_username = "ubuntu"
}
</code>
</pre>
</p>

<p>
Here we are using the <code>amazon-ebs</code> builder plugin. This will
basically launch an <code>ec2</code> instance from a source AMI, provision the
running machine, and then make an AMI out of that.  We are naming it
<code>ubuntu</code>
</p>
<p>
Each builder has its attributes. In this case <code>amazon-ebs</code> is going
to launch a <code>t2.micro</code> in <code>us-west-2</code> using an
<code>ubuntu-jammy</code> based image. Then it will create a new AMI image
named <code>learn-packer-linux-aws</code>.
</p>

<h3 id='build'>build block</h3>
<p>
Finally we have the <code>build</code> block. Here is where later we will add
stuff to provision the image with.

<pre>
<code>
build {
  sources = [
    "source.amazon-ebs.ubuntu"
  ]
}
</code>
</pre>
</p>

<p>
You can see the full <code>.pkr.hcl</code> file <a
href='https://github.com/bsantanad/hashicorp.learning/blob/main/packer/aws-ubuntu.pkr.hcl'>here</a>.
</p>

<h2 id='packer-cli'><code>packer</code> cli</h2>
<p>
Assuming you are inside the directory where you have the packer configuration
file
</p>
<ul>
    <li>
        <p><code>packer init .</code>: downloads plugins</p>
    </li>
    <li>
        <p><code>packer fmt .</code>: formats the configs</p>
    </li>
    <li>
        <p><code>packer validate .</code>: self-explanatory</p>
    </li>
    <li>
        <p><code>packer build aws-ubuntu.pkr.hcl</code>: build the image</p>
    </li>
</ul>
<p>
There is no subcommand for deleting an image. You need to <i>deregister</i>
(delete) the AMI from AWS directly, when you do it be sure to also delete the
snapshot that was created.
</p>

<h2 id='provision'>provision images</h2>
<p>
In the above example we just repackage an image that already exists.  Packer
becomes useful when we can configure that image to our liking, installing
different packages, setting up files, and then turning that into an image we
can reuse across a fleet of servers.
</p>
<p>
Packer can do this provisioning automatically, so you can setup a pipeline that
builds the image every time there is a trigger.
</p>
<h3 id='provision-template'>add provisioner to template</h3>
<p>
Continuing from the above example where we are using <code>amazon-ebs</code>,
we can review that we are using the <a
href="https://developer.hashicorp.com/packer/docs/communicators/ssh">ssh
communicator</a>.  Meaning that we will communicate to the <code>ec2</code>
instance via ssh. We are specifying a username (<code>ssh_username =
"ubuntu"</code>), which means for provisioning packer will use a temporary ssh
credentials.
</p>

<p>
Inside the build block we can add what we want to configure on the
<code>ec2</code> instance,  by using a <a
href="https://developer.hashicorp.com/packer/docs/provisioners">provisioner</a>.
We use the <code>shell</code> type which basically let us do whatever we want
with a shell.
<pre>
<code>
provisioner "shell" {
  environment_vars = [
    "FOO=hello world",
  ]
  inline = [
    "echo Installing Kubeadm",
    "sudo apt-get update",
    "sudo apt-get install -y kubeadm",
    "echo \"FOO is $FOO\" > example.txt",
  ]
}
</code>
</pre>
</p>

<p>
You can have multiple of these. So your build block would look something like:
<pre>
<code>
build {
  name = "learn-packer"
  sources = [
    "source.amazon-ebs.ubuntu"
  ]
  provisioner "shell" {
    environment_vars = [
      "FOO=hello world",
    ]
    inline = [
      "echo Installing Git",
      "sudo apt-get update",
      "sudo apt-get install -y git",
      "echo \"FOO is $FOO\" > example.txt",
    ]
  }
  provisioner "shell" {
    inline = [
      "echo \"Hello there my friend\"",
    ]
  }
}
</code>
</pre>
</p>

<p>
Then you go ahead and <code>packer build</code> it and you are good to go.
</p>

<h2 id='variables'>variables</h2>
<p>
You can add variables to your templates in order to not modify stuff directly
on the template every time you run it, say, modify a name, a version or
whatever.
</p>
<p>
There are two types
<ul>
  <li>
      <p>
        <b>input variable</b>: this can be added with command line flags,
        environment variables and so on.
<pre>
<code>
variable "ami_prefix" {
  type    = string
  default = "learn-packer-linux-aws-redis"
}
</code>
</pre>
        If you do not modify the variable, it will use the default value stated
        there.
      </p>
  </li>

  <li>
      <p>
        <b>local variable</b>: these are useful when you need to format commonly used
        values
<pre>
<code>
locals {
  timestamp = regex_replace(timestamp(), "[- TZ:]", "")
}
</code>
</pre>
        What is <code>timestamp</code> you ask? There are some <a
        href="https://developer.hashicorp.com/packer/docs/templates/hcl_templates/functions">built-in
        functions</a>.
      </p>
  </li>
</ul>
</p>
<p>
Do notice that the way you define them is different, for the <b>input</b> each
has its own block, and the type defined. For the <b>local</b> they are all
inside a block.
</p>
<p>
You call them like you were using some type of <code>fstring</code>s.
</p>
<pre>
<code>
"${var.ami_prefix}-${local.timestamp}"
</code>
</pre>

<h2 id='build-parallel'>build multiple images in parallel</h2>
<p>
You just need to create another <code>source</code> block, and add the name to
the <code>sources</code> array in your build block.
</p>
<pre>
<code>
build {
  name    = "learn-packer"
  sources = [
-    "source.amazon-ebs.ubuntu"
+    "source.amazon-ebs.ubuntu",
+    "source.amazon-ebs.ubuntu-focal"
  ]
  ## ...
}
</code>
</pre>

<h3 id='table'>~ table of contents</h3>
<ul>
  <li><a href='#what'>what is packer?</a></li>
  <li>
    <a href='#using'>packer file structure</a>
    <ul>
        <li><a href='#packer'>packer block</a></li>
        <li><a href='#source'>source block</a></li>
        <li><a href='#build'>build block</a></li>
    </ul>
  </li>
  <li> <a href='#packer-cli'><code>packer</code> cli</a> </li>
  <li>
    <a href='#provision'>provision</a>
    <ul>
        <li><a href='#provision-template'>add provisioner to template</a></li>
    </ul>
  </li>
  <li> <a href='#variables'>variables</a> </li>
  <li> <a href='#build-parallel'>build multiple images in parallel</a> </li>
</ul>

<p><a href='#top'>↑ go to the top</a></p>

</body>
</html>


